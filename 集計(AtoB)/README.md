# Slackチャット分析・集計ツール

このツールは、Slackチャットのメンション関係から送信者→受信者の評価指標を集計し、平均値を算出するツールです。

## 📁 ファイル構成

### 🔵 メインスクリプト

#### `analyze_chat.py`
**用途**: Slackチャットデータから送信者→受信者の評価指標を自動集計

**主な機能**:
- CSVファイルからチャットメッセージとユーザーIDを読み込み
- Slackメンション（`<@UXXXXXXXX>`形式）を正規表現で抽出
- 送信者→受信者ごとに評価指標を集計
- -1や空の値を除外して平均値を計算
- 結果をCSVファイルに出力

**処理の流れ**:
1. 入力CSVを読み込み（UTF-8 BOM付き対応）
2. 各行からメンションを抽出
3. 送信者→受信者→評価指標の3次元データ構造に格納
4. 評価指標ごとに平均値を計算
5. 結果をCSVに出力

---

### 🔸 補助スクリプト（テスト用・非推奨）

#### `export_result.py`
**用途**: ハードコードされたテストデータをCSVに出力

**注意**: 実際のデータ処理には使用せず、`analyze_chat.py`を使用してください。

#### `export_result_abs.py`
**用途**: 同上（絶対パス指定版）

**注意**: 実際のデータ処理には使用せず、`analyze_chat.py`を使用してください。

---

### 📄 出力ファイル

#### `result.csv`
`analyze_chat.py`実行後に生成される集計結果ファイル

---

## 📊 入力CSVの構造

`analyze_chat.py`が想定する入力CSVファイルの構造：

### ファイル名
`農林中金デモ_チャット分析 - 送信者あり_点数定義 (1).csv`

### 列構成

| 列番号 | 列名 | 説明 | 例 |
|-------|------|------|-----|
| 0 | 送信者 | メッセージ送信者のSlack ID | `U06GH542GMS` |
| 1 | チャット内容 | メッセージ本文（メンション含む） | `<@U05UC2VE5LM> お疲れ様です` |
| 2 | 期待支援力 | 評価指標1（数値） | `23.33` |
| 3 | 行動支援力 | 評価指標2（数値） | `22.0` |
| 4 | 指示が明確か | 評価指標3（数値） | `69.17` |
| 5 | 責任が明確か | 評価指標4（数値） | `52.22` |
| 6 | 言い回し力 | 評価指標5（数値） | `74.09` |

### CSVサンプル

```csv
送信者,チャット内容,期待支援力,行動支援力,指示が明確か,責任が明確か,言い回し力
U06GH542GMS,<@U05UC2VE5LM> お疲れ様です。確認お願いします,23.33,22.0,69.17,52.22,74.09
U06GH542GMS,<@U06GH5462R2> 資料の件、どうでしょうか?,23.33,27.5,66.15,57.14,71.82
U05UC2VE5LM,<@U06GH542GMS> 承知しました,45.0,0.0,53.33,60.0,60.0
```

### 注意事項
- エンコーディング: **UTF-8（BOM付き）**推奨
- ヘッダー行: 必須（1行目）
- 空の評価値や`-1`は平均計算から除外されます
- メンションは`<@UXXXXXXXX>`形式（Slack標準形式）

---

## 📤 出力CSVの構造

### ファイル名
`result.csv`

### 列構成

| 列名 | 説明 | 例 |
|-----|------|-----|
| 送信者 | メッセージ送信者ID | `U06GH542GMS` |
| 受信者 | メンション先のユーザーID | `U05UC2VE5LM` |
| 期待支援力 | 平均値（小数点第2位まで） | `23.33` |
| 行動支援力 | 平均値（小数点第2位まで） | `22.0` |
| 指示が明確か | 平均値（小数点第2位まで） | `69.17` |
| 責任が明確か | 平均値（小数点第2位まで） | `52.22` |
| 言い回し力 | 平均値（小数点第2位まで） | `74.09` |

### 出力サンプル

```csv
送信者,受信者,期待支援力,行動支援力,指示が明確か,責任が明確か,言い回し力
U06GH542GMS,U05UC2VE5LM,23.33,22.0,69.17,52.22,74.09
U06GH542GMS,U06GH5462R2,23.33,27.5,66.15,57.14,71.82
U05UC2VE5LM,U06GH542GMS,45.0,0.0,53.33,60.0,60.0
```

### 特徴
- 送信者→受信者のペアごとに1行
- 各評価指標は複数メッセージの平均値
- 空の値は空文字列として出力

---

## 🚀 使用方法

### 前提条件

**必要なPythonライブラリ**:
```powershell
pip install pandas
```

**Python標準ライブラリ**（インストール不要）:
- csv
- re
- collections

---

### 実行手順

#### 1. 入力ファイルの準備
`農林中金デモ_チャット分析 - 送信者あり_点数定義 (1).csv`を同じフォルダに配置します。

#### 2. スクリプトの実行

PowerShellで以下のコマンドを実行：

```powershell
cd "C:\Users\looka\OneDrive\ドキュメント\job\slack\集計(AtoB)"
python analyze_chat.py
```

#### 3. 実行中の出力

スクリプト実行中、以下の情報が表示されます：

```
メトリックインデックス: {'期待支援力': 2, '行動支援力': 3, '指示が明確か': 4, '責任が明確か': 5, '言い回し力': 6}
行 1: 送信者=U06GH542GMS, 受信者=['U05UC2VE5LM'], 指標={'期待支援力': '23.33', '行動支援力': '22.0', ...}
...
処理行数: 3056, メンションがある行数: 1234

データ構造の内容 (一部):
送信者: U06GH542GMS, 受信者: U05UC2VE5LM
  期待支援力: 10個の値
  行動支援力: 10個の値
...

データ件数: 45行
DataFrame先頭5行:
           送信者        受信者  期待支援力  行動支援力
0  U06GH542GMS  U05UC2VE5LM   23.33    22.0
...

結果がresult.csvに保存されました
```

#### 4. 結果の確認

`result.csv`が生成されます。Excelや任意のCSVエディタで開いて確認できます。

---

## 🔧 カスタマイズ

### 入力ファイル名を変更する場合

`analyze_chat.py`の27行目を編集：

```python
input_file = 'あなたのファイル名.csv'
```

### 出力ファイル名を変更する場合

`analyze_chat.py`の29行目を編集：

```python
output_file = '出力ファイル名.csv'
```

### 評価指標を追加・変更する場合

`analyze_chat.py`の42-48行目を編集：

```python
metric_indices = {
    '期待支援力': 2,
    '行動支援力': 3,
    '指示が明確か': 4,
    '責任が明確か': 5,
    '言い回し力': 6,
    '新しい指標': 7  # 追加例
}
```

---

## 📝 主要な関数の説明

### `extract_mentions(text)`
**引数**: `text` (str) - チャットメッセージ本文  
**戻り値**: メンションされたユーザーIDのリスト  
**処理**: 正規表現`<@(U[A-Z0-9]+)>`でメンションを抽出。`all`と`here`は除外。

### `calculate_average(values)`
**引数**: `values` (list) - 数値のリスト  
**戻り値**: 平均値（float、小数点第2位まで）  
**処理**: 空の値と`-1`を除外して平均を計算。有効な値がない場合は空文字列を返す。

### `main()`
メイン処理関数。CSVの読み込み、データ集計、平均計算、結果出力を一連で実行。

---

## ⚠️ 注意事項

1. **入力ファイルのエンコーディング**  
   UTF-8（BOM付き）を推奨。`utf-8-sig`で読み込まれます。

2. **メンション形式**  
   Slack標準の`<@UXXXXXXXX>`形式のみ対応。チャンネルメンション（`<!here>`など）は除外されます。

3. **評価値の扱い**  
   - 空の値や`-1`は平均計算から除外
   - 数値以外の値が含まれるとエラーになる可能性があります

4. **大規模データ処理**  
   数千行以上のデータでも処理可能ですが、メモリ使用量に注意してください。

5. **重複データ**  
   同じ送信者→受信者のペアが複数回出現した場合、すべて集計して平均を取ります。

---

## 🐛 トラブルシューティング

### エラー: `FileNotFoundError`
**原因**: 入力CSVファイルが見つからない  
**解決**: ファイル名とパスを確認し、スクリプトと同じフォルダに配置してください。

### エラー: `UnicodeDecodeError`
**原因**: CSVファイルのエンコーディングが対応していない  
**解決**: ファイルをUTF-8（BOM付き）で保存し直してください。

### 警告: `結果のデータフレームが空です`
**原因**: メンションを含む行が1つも見つからなかった  
**解決**: 入力CSVのチャット内容列に`<@UXXXXXXXX>`形式のメンションが含まれているか確認してください。

### エラー: `KeyError` または `IndexError`
**原因**: CSV列の構造が想定と異なる  
**解決**: 入力CSVの列構成を確認し、必要に応じて`metric_indices`を修正してください。

---

## 📚 関連ツール

### 前処理ツール: `slack用csv格納`
SlackエクスポートJSON→CSV変換ツール。このツールで送信者IDを自動付与した後、`analyze_chat.py`で集計します。

**処理フロー**:
```
1. slack用csv格納/extract_user_for_csv.py
   ↓ SlackのJSONからユーザーIDを抽出
   
2. 集計(AtoB)/analyze_chat.py
   ↓ 評価指標を集計・平均化
   
3. result.csv（完成）
```

---

## 📜 ライセンス

社内ツールとして使用してください。

---

## 📞 お問い合わせ

不明点や改善要望があれば、開発担当者までご連絡ください。

