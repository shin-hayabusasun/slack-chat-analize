# Slack CSV ユーザーID抽出ツール

このツールは、SlackエクスポートJSON（チャット履歴）からユーザー情報を抽出し、CSVファイルのメッセージ本文に対応する送信者IDを自動的に割り当てるツールです。Slackチャットデータ分析の前処理として使用します。

## 📁 ファイル構成

### 🔵 メインスクリプト

#### `extract_user_for_csv.py`
**用途**: SlackエクスポートJSON → CSV送信者ID自動付与

**主な機能**:
- SlackエクスポートJSON（複数ファイル）から全メッセージを読み込み
- メッセージテキストとユーザーIDの対応表を作成
- 既存CSVのメッセージ本文からユーザーIDを逆引き
- テキスト正規化により、空白・改行の違いを吸収
- チャンネル参加メッセージも処理
- A列（送信者ID）を自動設定してCSVを更新

**処理の流れ**:
1. 既存CSVを読み込み（A列は空でもOK）
2. SlackエクスポートJSONフォルダ内の全ファイルを処理
3. メッセージテキスト→ユーザーIDの対応表を構築
4. CSVのB列（メッセージ本文）に一致するテキストを検索
5. 一致したらA列に対応するユーザーIDを設定
6. 更新したCSVを上書き保存

---

### 📄 その他のファイル

#### `demo.csv`
サンプルCSVファイル（動作確認用）

#### `readme.md`
このファイル

---

## 📊 入力データの構造

このツールは2種類の入力データを使用します。

### 1. SlackエクスポートJSON（ディレクトリ）

#### ディレクトリ構造
```
lbs-pf-dx診断サービス/
├── 2024-01-01.json
├── 2024-01-02.json
├── 2024-01-03.json
└── ...
```

#### JSONファイル形式
各JSONファイルは、その日のチャットメッセージの配列です。

**通常メッセージの例**:
```json
[
  {
    "type": "message",
    "user": "U06GH542GMS",
    "text": "<@U05UC2VE5LM> お疲れ様です。確認お願いします",
    "ts": "1704067200.000100"
  },
  {
    "type": "message",
    "user": "U05UC2VE5LM",
    "text": "承知しました",
    "ts": "1704067300.000200"
  }
]
```

**チャンネル参加メッセージの例**:
```json
{
  "type": "message",
  "subtype": "channel_join",
  "user": "U06GH542GMS",
  "text": "<@U06GH542GMS> さんがチャンネルに参加しました",
  "ts": "1704067400.000300"
}
```

#### 必須フィールド
- `text`: メッセージ本文
- `user`: 送信者のSlack ID

---

### 2. 入力CSV

#### ファイル名
`農林中金デモ_チャット分析 - 送信者あり_点数定義.csv`  
（スクリプト内で指定）

#### 列構成（処理前）

| 列番号 | 列名 | 説明 | 例 | 状態 |
|-------|------|------|-----|------|
| 0 | 送信者 | **空欄または不完全** | （空） | ⚠️ 自動補完対象 |
| 1 | チャット内容 | メッセージ本文 | `<@U05UC2VE5LM> お疲れ様です` | ✅ 既存 |
| 2 | 期待支援力 | 評価指標1 | `23.33` | ✅ 既存 |
| 3 | 行動支援力 | 評価指標2 | `22.0` | ✅ 既存 |
| 4 | 指示が明確か | 評価指標3 | `69.17` | ✅ 既存 |
| 5 | 責任が明確か | 評価指標4 | `52.22` | ✅ 既存 |
| 6 | 言い回し力 | 評価指標5 | `74.09` | ✅ 既存 |

#### 入力CSVサンプル（処理前）

```csv
送信者,チャット内容,期待支援力,行動支援力,指示が明確か,責任が明確か,言い回し力
,<@U05UC2VE5LM> お疲れ様です。確認お願いします,23.33,22.0,69.17,52.22,74.09
,<@U06GH5462R2> 資料の件、どうでしょうか?,23.33,27.5,66.15,57.14,71.82
,承知しました,45.0,0.0,53.33,60.0,60.0
```

**注意点**:
- A列（送信者）は空欄でOK（このツールが自動補完）
- B列（チャット内容）は必須
- エンコーディング: UTF-8（BOM付き/なし両対応）

---

## 📤 出力CSVの構造

### ファイル名
入力と同じファイル名（上書き保存）  
`農林中金デモ_チャット分析 - 送信者あり_点数定義.csv`

### 列構成（処理後）

| 列番号 | 列名 | 説明 | 例 | 変更 |
|-------|------|------|-----|------|
| 0 | 送信者 | **自動補完されたSlack ID** | `U06GH542GMS` | ✅ 更新 |
| 1 | チャット内容 | メッセージ本文 | `<@U05UC2VE5LM> お疲れ様です` | - |
| 2 | 期待支援力 | 評価指標1 | `23.33` | - |
| 3 | 行動支援力 | 評価指標2 | `22.0` | - |
| 4 | 指示が明確か | 評価指標3 | `69.17` | - |
| 5 | 責任が明確か | 評価指標4 | `52.22` | - |
| 6 | 言い回し力 | 評価指標5 | `74.09` | - |

### 出力CSVサンプル（処理後）

```csv
送信者,チャット内容,期待支援力,行動支援力,指示が明確か,責任が明確か,言い回し力
U06GH542GMS,<@U05UC2VE5LM> お疲れ様です。確認お願いします,23.33,22.0,69.17,52.22,74.09
U06GH542GMS,<@U06GH5462R2> 資料の件、どうでしょうか?,23.33,27.5,66.15,57.14,71.82
U05UC2VE5LM,承知しました,45.0,0.0,53.33,60.0,60.0
```

### 変更点
- **A列（送信者）**: 空欄 → Slack ID（例: `U06GH542GMS`）が自動入力される
- **その他の列**: 変更なし

---

## 🚀 使用方法

### 前提条件

**必要なPythonライブラリ**:
```powershell
pip install pandas
```

**Python標準ライブラリ**（インストール不要）:
- json
- csv
- os
- re

---

### 実行手順

#### 1. SlackエクスポートJSONを準備

Slackワークスペースからチャット履歴をエクスポートし、ZIPファイルを展開しておきます。

**エクスポート方法**:
1. Slackワークスペース設定 → 「設定と管理」 → 「データのエクスポート」
2. エクスポートした日付範囲のZIPをダウンロード
3. ZIPを展開してJSONファイルのディレクトリを確認

---

#### 2. スクリプトの設定

`extract_user_for_csv.py`の8行目と11行目を編集：

```python
# 8行目: SlackエクスポートJSONのディレクトリパス
json_dir = r"C:\Users\looka\Downloads\lbs-pf-dx診断サービス (2)\lbs-pf-dx診断サービス"

# 11行目: 処理対象のCSVファイル名
output_csv = "農林中金デモ_チャット分析 - 送信者あり_点数定義.csv"
```

**パスの指定方法**:
- 絶対パス: `r"C:\Users\...\ディレクトリ名"` （推奨）
- 相対パス: `"./データフォルダ"` （スクリプトと同じ場所の場合）

---

#### 3. スクリプトの実行

PowerShellで以下のコマンドを実行：

```powershell
cd "C:\Users\looka\OneDrive\ドキュメント\job\slack\slack用csv格納"
python extract_user_for_csv.py
```

---

#### 4. 実行中の出力

スクリプト実行中、以下の情報が表示されます：

```
既存のCSVファイルを読み込んでいます: 農林中金デモ_チャット分析 - 送信者あり_点数定義.csv
CSVから 3056 行のテキストを読み込みました
JSONディレクトリを処理しています: C:\Users\looka\Downloads\lbs-pf-dx診断サービス (2)\lbs-pf-dx診断サービス
処理中: 2024-01-01.json
処理中: 2024-01-02.json
処理中: 2024-01-03.json
...
JSONから 4523 件のメッセージと 12 件のチャンネル参加メッセージを抽出しました
全 3056 行中 2891 行にユーザーIDを割り当てました
農林中金デモ_チャット分析 - 送信者あり_点数定義.csv が更新されました。
```

---

#### 5. 結果の確認

更新されたCSVファイルを開き、A列（送信者）にSlack IDが入っていることを確認します。

---

## 🔧 処理ロジックの詳細

### 1. テキスト正規化
メッセージ本文の空白・改行の違いを吸収して照合します。

**正規化処理**:
```python
def normalize_text(text):
    # 空白と改行を1つの空白に置換
    text = re.sub(r'\s+', ' ', text).strip()
    return text
```

**例**:
```
元のテキスト:  "お疲れ様です。\n確認お願いします"
正規化後:      "お疲れ様です。 確認お願いします"
```

---

### 2. マッチング優先順位

CSV各行に対して、以下の順序でユーザーIDを検索します：

1. **完全一致（元のテキスト）**: `text in user_text_map`
2. **正規化一致（元のテキスト）**: `norm_text in user_text_map`
3. **完全一致（チャンネル参加）**: `text in channel_join_map`
4. **正規化一致（チャンネル参加）**: `norm_text in channel_join_map`
5. **パターンマッチ**: `<@UXXXXXXXX> さんがチャンネルに参加しました`

最初に一致した時点で、そのユーザーIDを割り当てます。

---

### 3. チャンネル参加メッセージの処理

「さんがチャンネルに参加しました」メッセージから直接ユーザーIDを抽出：

```python
user_id_match = re.search(r'<@([A-Z0-9]+)>', text)
```

**例**:
```
入力: "<@U06GH542GMS> さんがチャンネルに参加しました"
抽出: "U06GH542GMS"
```

---

## 📝 主要な関数の説明

### `normalize_text(text)`
**引数**: `text` (str) - メッセージ本文  
**戻り値**: 正規化されたテキスト（str）  
**処理**: 連続する空白・改行を1つの空白に置換し、前後の空白を削除。

### メイン処理
1. **CSV読み込み**: `pd.read_csv(output_csv)`
2. **JSON読み込み**: `json.load(f)` でディレクトリ内全ファイル
3. **辞書構築**: `user_text_map` と `channel_join_map`
4. **マッチング**: CSVのB列テキストから辞書を逆引き
5. **CSV更新**: `df.to_csv(output_csv, index=False)`

---

## ⚠️ 注意事項

### 1. ファイルパス
- Windowsパスは `r"C:\Users\..."` のように `r` プレフィックスを付けてください
- 日本語を含むパスも対応していますが、エラー時は英数字パスを試してください

### 2. エンコーディング
- CSV: UTF-8（BOM付き/なし両対応）
- JSON: UTF-8（Slackエクスポートの標準形式）

### 3. データの上書き
- **元のCSVファイルを上書き保存**します
- 実行前にバックアップを取ることを推奨

### 4. 一致しないメッセージ
- JSONに存在しないメッセージはA列が空のまま残ります
- ログで「全 X 行中 Y 行にユーザーIDを割り当てました」を確認してください

### 5. 重複テキスト
- 同じ本文のメッセージが複数のユーザーから送信された場合、最後に処理されたユーザーIDが設定されます
- より正確な処理が必要な場合は、タイムスタンプも考慮するようカスタマイズしてください

### 6. メモリ使用量
- 大量のJSONファイル（数千ファイル）を処理する場合、メモリ使用量に注意してください
- 必要に応じて日付範囲を分割して処理してください

---

## 🐛 トラブルシューティング

### エラー: `FileNotFoundError: [Errno 2] No such file or directory`
**原因**: JSONディレクトリまたはCSVファイルが見つからない  
**解決**: 
- `json_dir` と `output_csv` のパスを確認
- ファイルが実際に存在するか確認
- パスに `r` プレフィックスを付ける（例: `r"C:\Users\..."`）

### エラー: `JSONDecodeError`
**原因**: JSONファイルの形式が不正  
**解決**: 
- SlackエクスポートZIPを正しく展開したか確認
- 該当JSONファイルをテキストエディタで開いて内容を確認
- エラーメッセージに表示されたファイルをスキップして再実行

### エラー: `UnicodeDecodeError`
**原因**: CSVファイルのエンコーディングが対応していない  
**解決**: 
- CSVをUTF-8で保存し直す
- Excel等でCSVを開いて「UTF-8で保存」を選択

### 警告: ユーザーIDを割り当てた行数が少ない
**原因**: CSVのメッセージ本文とJSONのメッセージが一致しない  
**解決**: 
- JSONディレクトリに対象期間のデータが含まれているか確認
- CSVのメッセージ本文が元のSlackメッセージから編集されていないか確認
- いくつかのメッセージをサンプルで比較

### エラー: `PermissionError`
**原因**: CSVファイルが他のプログラムで開かれている  
**解決**: 
- Excel等でCSVを開いている場合は閉じる
- ファイルの読み取り専用属性を解除

---

## 📚 次のステップ

### このツールの後に実行するツール

#### `集計(AtoB)/analyze_chat.py`
送信者IDが付与されたCSVから、送信者→受信者の評価指標を集計します。

**処理フロー**:
```
1. slack用csv格納/extract_user_for_csv.py
   ↓ SlackのJSONからユーザーIDを抽出・付与
   
2. 集計(AtoB)/analyze_chat.py
   ↓ 評価指標を集計・平均化
   
3. result.csv（完成）
```

**実行例**:
```powershell
# 1. ユーザーID抽出（このツール）
cd "C:\Users\looka\OneDrive\ドキュメント\job\slack\slack用csv格納"
python extract_user_for_csv.py

# 2. 集計処理
cd "C:\Users\looka\OneDrive\ドキュメント\job\slack\集計(AtoB)"
python analyze_chat.py
```

---

## 🔄 カスタマイズ例

### 出力CSVを別ファイルにする場合

```python
# 11行目: 入力CSV
input_csv = "農林中金デモ_チャット分析 - 送信者あり_点数定義.csv"

# 23行目: 既存のCSVファイルを読み込む
df = pd.read_csv(input_csv)

# 95行目: 別ファイルに保存
output_csv = "農林中金デモ_チャット分析 - 送信者あり_点数定義_updated.csv"
df.to_csv(output_csv, index=False)
```

### タイムスタンプも考慮する場合

メッセージ本文だけでなく、タイムスタンプも使って精度を上げる：

```python
# 辞書のキーを (text, ts) のタプルにする
user_text_map[(text, ts)] = user

# マッチング時も同様に
if (text, ts) in user_text_map:
    df.iloc[i, 0] = user_text_map[(text, ts)]
```

---

## 📜 ライセンス

社内ツールとして使用してください。

---

## 📞 お問い合わせ

不明点や改善要望があれば、開発担当者までご連絡ください。
