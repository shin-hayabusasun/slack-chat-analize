# Slack チャット分析ツール集

Slackチャットデータを分析し、送信者→受信者間のコミュニケーション評価指標を算出するツール群です。

## 📋 目次

- [概要](#概要)
- [処理フロー全体像](#処理フロー全体像)
- [フォルダ構成](#フォルダ構成)
- [クイックスタートガイド](#クイックスタートガイド)
- [各ツールの詳細](#各ツールの詳細)
- [必要な環境](#必要な環境)
- [よくある質問](#よくある質問)

---

## 📖 概要

このツール集は、以下の2ステップでSlackチャットデータを分析します：

### ステップ1: ユーザーID抽出（前処理）
📁 `slack用csv格納/extract_user_for_csv.py`

SlackエクスポートJSON（チャット履歴）から、メッセージ本文に対応する送信者IDを自動抽出してCSVに付与します。

### ステップ2: 評価指標集計（分析）
📁 `集計(AtoB)/analyze_chat.py`

送信者IDが付与されたCSVから、メンション関係を分析し、送信者→受信者ごとの評価指標（期待支援力、行動支援力など）の平均値を算出します。

---

## 🔄 処理フロー全体像

```
┌─────────────────────────────────────────┐
│ SlackエクスポートJSON                    │
│ (チャット履歴)                           │
│ - 2024-01-01.json                       │
│ - 2024-01-02.json                       │
│ - ...                                   │
└─────────────────┬───────────────────────┘
                  │
                  │ ステップ1: ユーザーID抽出
                  ↓
┌─────────────────────────────────────────┐
│ slack用csv格納/                          │
│ extract_user_for_csv.py                 │
│                                         │
│ 【処理内容】                             │
│ - JSONから全メッセージを読み込み         │
│ - テキスト→ユーザーIDの対応表を作成      │
│ - CSVのA列（送信者）を自動補完           │
└─────────────────┬───────────────────────┘
                  │
                  ↓
┌─────────────────────────────────────────┐
│ CSVファイル（送信者ID付き）               │
│                                         │
│ 送信者,チャット内容,期待支援力,行動支援力...│
│ U06GH542GMS,<@U05UC2VE5LM> お疲れ様です,23.33,22.0...│
│ U06GH542GMS,<@U06GH5462R2> 資料の件...,23.33,27.5...│
└─────────────────┬───────────────────────┘
                  │
                  │ ステップ2: 評価指標集計
                  ↓
┌─────────────────────────────────────────┐
│ 集計(AtoB)/                              │
│ analyze_chat.py                         │
│                                         │
│ 【処理内容】                             │
│ - メンション（<@UXXXXX>）を抽出          │
│ - 送信者→受信者のペアごとに集計          │
│ - 評価指標の平均値を計算                 │
└─────────────────┬───────────────────────┘
                  │
                  ↓
┌─────────────────────────────────────────┐
│ result.csv（最終結果）                   │
│                                         │
│ 送信者,受信者,期待支援力,行動支援力...     │
│ U06GH542GMS,U05UC2VE5LM,23.33,22.0...   │
│ U06GH542GMS,U06GH5462R2,23.33,27.5...   │
│ （送信者→受信者のペアごとの平均値）       │
└─────────────────────────────────────────┘
```

---

## 📁 フォルダ構成

```
slack/
├── README.md                        # このファイル（全体の説明）
│
├── slack用csv格納/                   # ステップ1: ユーザーID抽出ツール
│   ├── readme.md                    # 詳細なドキュメント
│   ├── extract_user_for_csv.py     # メインスクリプト
│   └── demo.csv                     # サンプルファイル
│
└── 集計(AtoB)/                       # ステップ2: 評価指標集計ツール
    ├── README.md                    # 詳細なドキュメント
    ├── analyze_chat.py              # メインスクリプト
    ├── export_result.py             # テスト用（非推奨）
    ├── export_result_abs.py         # テスト用（非推奨）
    └── result.csv                   # 出力結果
```

---

## 🚀 クイックスタートガイド

### 必要なもの

1. **Slackエクスポートデータ**（ZIPファイルを展開したもの）
2. **評価データ付きCSV**（チャット内容と評価指標が含まれるファイル）
3. **Python 3.x** + pandas

### インストール

```powershell
pip install pandas
```

---

### 実行手順

#### 📍 ステップ1: ユーザーID抽出

```powershell
# 1. slack用csv格納フォルダに移動
cd "C:\Users\looka\OneDrive\ドキュメント\job\slack\slack用csv格納"

# 2. スクリプトを編集（8行目と11行目）
# - json_dir: SlackエクスポートJSONのパス
# - output_csv: 処理対象のCSVファイル名

# 3. 実行
python extract_user_for_csv.py
```

**実行結果**:
- CSVのA列（送信者）にSlack IDが自動入力されます
- 例: `U06GH542GMS`

**詳細**: [slack用csv格納/readme.md](./slack用csv格納/readme.md)

---

#### 📍 ステップ2: 評価指標集計

```powershell
# 1. 集計(AtoB)フォルダに移動
cd "C:\Users\looka\OneDrive\ドキュメント\job\slack\集計(AtoB)"

# 2. 入力CSVを配置
# 「農林中金デモ_チャット分析 - 送信者あり_点数定義 (1).csv」
# （ステップ1で処理したファイル）

# 3. 実行
python analyze_chat.py
```

**実行結果**:
- `result.csv`が生成されます
- 送信者→受信者のペアごとに評価指標の平均値が出力されます

**詳細**: [集計(AtoB)/README.md](./集計(AtoB)/README.md)

---

## 📊 各ツールの詳細

### 1️⃣ slack用csv格納（ユーザーID抽出ツール）

| 項目 | 内容 |
|------|------|
| **スクリプト** | `extract_user_for_csv.py` |
| **入力** | ① SlackエクスポートJSON<br>② CSVファイル（A列が空でもOK） |
| **出力** | CSVファイル（A列にユーザーID追加） |
| **処理時間** | 数秒〜数十秒（JSONファイル数による） |
| **主な機能** | - JSON→CSV変換<br>- テキスト正規化<br>- ユーザーID自動補完 |

#### 主要機能

- **テキスト正規化**: 空白・改行の違いを吸収して高精度マッチング
- **チャンネル参加対応**: 「さんがチャンネルに参加しました」も処理
- **複数JSON対応**: ディレクトリ内の全JSONファイルを一括処理

#### 設定が必要な項目

```python
# 8行目
json_dir = r"C:\Users\...\SlackエクスポートJSONのディレクトリ"

# 11行目
output_csv = "処理対象のCSVファイル名.csv"
```

📖 **詳細ドキュメント**: [slack用csv格納/readme.md](./slack用csv格納/readme.md)

---

### 2️⃣ 集計(AtoB)（評価指標集計ツール）

| 項目 | 内容 |
|------|------|
| **スクリプト** | `analyze_chat.py` |
| **入力** | CSVファイル（送信者ID、チャット内容、評価指標） |
| **出力** | `result.csv`（送信者→受信者の評価平均値） |
| **処理時間** | 数秒〜数分（データ量による） |
| **主な機能** | - メンション抽出<br>- 評価指標集計<br>- 平均値計算 |

#### 主要機能

- **メンション抽出**: `<@UXXXXXXXX>`形式を正規表現で自動検出
- **3次元集計**: 送信者→受信者→評価指標の階層構造で管理
- **平均値計算**: -1や空の値を除外して正確な平均を算出

#### 評価指標（デフォルト）

1. 期待支援力
2. 行動支援力
3. 指示が明確か
4. 責任が明確か
5. 言い回し力

#### 設定が必要な項目

```python
# 27行目
input_file = '入力CSVファイル名.csv'

# 29行目
output_file = 'result.csv'

# 42-48行目（評価指標の列番号）
metric_indices = {
    '期待支援力': 2,
    '行動支援力': 3,
    ...
}
```

📖 **詳細ドキュメント**: [集計(AtoB)/README.md](./集計(AtoB)/README.md)

---

## 💻 必要な環境

### ソフトウェア要件

| 項目 | バージョン | インストール方法 |
|------|-----------|----------------|
| Python | 3.6以上 | [python.org](https://www.python.org/) |
| pandas | 最新版 | `pip install pandas` |

### Python標準ライブラリ（インストール不要）

- json
- csv
- os
- re
- collections

### 動作確認済み環境

- **OS**: Windows 10/11
- **Python**: 3.8, 3.9, 3.10
- **PowerShell**: 5.1以上

---

## ❓ よくある質問

### Q1: どのツールから実行すればいいですか？

**A**: 必ず **ステップ1（slack用csv格納）→ ステップ2（集計AtoB）** の順で実行してください。

ステップ1でCSVにユーザーIDを付与した後、ステップ2で集計を行います。

---

### Q2: SlackエクスポートJSONはどうやって取得しますか？

**A**: Slackワークスペースの管理者権限が必要です。

1. Slackワークスペース設定を開く
2. 「設定と管理」→「データのエクスポート」
3. エクスポート期間を選択してダウンロード
4. ZIPファイルを展開

詳細: [slack用csv格納/readme.md](./slack用csv格納/readme.md#1-slackエクスポートjsonを準備)

---

### Q3: CSVファイルのA列（送信者）が空でも大丈夫ですか？

**A**: はい、大丈夫です。

ステップ1の`extract_user_for_csv.py`が自動的にA列を補完します。B列（チャット内容）が必須です。

---

### Q4: エラー「FileNotFoundError」が出ます

**A**: 以下を確認してください：

1. **ファイルパスの確認**
   - スクリプト内のパスが正しいか
   - ファイルが実際に存在するか

2. **パスの記述方法**
   ```python
   # 正しい書き方
   json_dir = r"C:\Users\looka\Downloads\..."
   
   # 間違った書き方（rが抜けている）
   json_dir = "C:\Users\looka\Downloads\..."
   ```

3. **ファイル名の確認**
   - 拡張子まで正確に記述されているか
   - 全角・半角の違いがないか

---

### Q5: 処理時間はどのくらいかかりますか？

**A**: データ量によりますが、目安は以下の通りです：

| 処理 | JSONファイル数/CSV行数 | 処理時間 |
|------|----------------------|---------|
| ステップ1 | 100ファイル | 10〜30秒 |
| ステップ1 | 1000ファイル | 1〜3分 |
| ステップ2 | 1000行 | 数秒 |
| ステップ2 | 10000行 | 10〜30秒 |

---

### Q6: 評価指標を追加したい場合は？

**A**: 両方のスクリプトを修正する必要があります。

**ステップ1（CSV準備時）**:
- CSVに新しい列を追加

**ステップ2（集計時）**:
- `analyze_chat.py`の`metric_indices`を編集（42-48行目）

```python
metric_indices = {
    '期待支援力': 2,
    '行動支援力': 3,
    '指示が明確か': 4,
    '責任が明確か': 5,
    '言い回し力': 6,
    '新しい指標': 7  # ← 追加
}
```

---

### Q7: 一部のメッセージにユーザーIDが付与されません

**A**: 以下の原因が考えられます：

1. **JSONに該当メッセージが存在しない**
   - エクスポート期間を確認
   - メッセージがボットからの送信でないか確認

2. **テキストが完全に一致していない**
   - CSVのメッセージが編集されていないか確認
   - 正規化処理でも吸収できないほど違う場合

3. **解決方法**
   - JSONのエクスポート期間を広げる
   - CSVのメッセージを元のSlackメッセージと照合

---

### Q8: 同じメッセージ本文を複数のユーザーが送信している場合は？

**A**: 最後に処理されたユーザーIDが設定されます。

より正確な処理が必要な場合は、タイムスタンプも考慮するようカスタマイズが必要です。

詳細: [slack用csv格納/readme.md](./slack用csv格納/readme.md#カスタマイズ例)

---

### Q9: result.csvを別のファイル名で保存したい

**A**: `analyze_chat.py`の29行目を編集：

```python
output_file = '任意のファイル名.csv'
```

---

### Q10: 処理結果をExcelで開くと文字化けします

**A**: CSVファイルのエンコーディングの問題です。

**解決方法**:
1. Excelで「データ」→「テキストから」で開く
2. エンコーディングを「UTF-8」に指定
3. または、Pythonスクリプトで`encoding='utf-8-sig'`に変更

---

## 🔧 トラブルシューティング

### よくあるエラーと解決方法

| エラー | 原因 | 解決方法 |
|--------|------|---------|
| `FileNotFoundError` | ファイルが見つからない | パスとファイル名を確認 |
| `UnicodeDecodeError` | エンコーディング不一致 | UTF-8で保存し直す |
| `JSONDecodeError` | JSON形式が不正 | Slackエクスポートを再取得 |
| `KeyError` / `IndexError` | CSV列構造が違う | 列番号を確認 |
| `PermissionError` | ファイルが開かれている | Excelなどを閉じる |

**詳細なトラブルシューティング**:
- [slack用csv格納/readme.md - トラブルシューティング](./slack用csv格納/readme.md#-トラブルシューティング)
- [集計(AtoB)/README.md - トラブルシューティング](./集計(AtoB)/README.md#-トラブルシューティング)

---

## 📚 関連資料

### 各ツールの詳細ドキュメント

- **[slack用csv格納/readme.md](./slack用csv格納/readme.md)** - ユーザーID抽出ツールの完全ガイド
- **[集計(AtoB)/README.md](./集計(AtoB)/README.md)** - 評価指標集計ツールの完全ガイド

### ドキュメント内容

各詳細ドキュメントには以下の情報が含まれています：

- 📊 入力・出力CSVの詳細な構造
- 🔧 カスタマイズ方法
- 📝 関数の詳細説明
- 🐛 トラブルシューティング
- 💡 カスタマイズ例

---

## 🎯 推奨される使い方

### 初回実行時

1. **サンプルデータで動作確認**
   - 小規模なデータ（10〜100メッセージ）で試す
   - 各ステップの出力を確認

2. **本番データで実行**
   - 元データのバックアップを取る
   - ステップごとに結果を確認

### 定期的な分析

1. **週次/月次でデータを更新**
   - 新しいSlackエクスポートを取得
   - 同じ手順で再実行

2. **結果の比較**
   - 過去のresult.csvと比較
   - 評価指標の変化を追跡

---

## 📈 出力データの活用

### result.csvの分析例

1. **個人別の傾向分析**
   - 特定の送信者の評価平均
   - 送信先による評価の違い

2. **チーム全体の可視化**
   - ネットワーク図の作成
   - ヒートマップの作成

3. **時系列分析**
   - 定期的に実行して変化を追跡
   - 改善施策の効果測定

---

## 📞 サポート

### 問い合わせ先

不明点や改善要望があれば、開発担当者までご連絡ください。

### バグ報告

以下の情報を含めて報告してください：

1. 実行したコマンド
2. エラーメッセージ（全文）
3. 入力ファイルのサンプル（一部でOK）
4. 実行環境（OS、Pythonバージョン）

---

## 📜 ライセンス

社内ツールとして使用してください。

---

## 🔄 更新履歴

| 日付 | バージョン | 内容 |
|------|-----------|------|
| 2026-01-01 | 1.0 | 初版作成 |

---

## 🎓 付録: データ構造の詳細

### Slack IDの形式

- **ユーザーID**: `U` + 英数字10文字（例: `U06GH542GMS`）
- **チャンネルID**: `C` + 英数字10文字（例: `C01234ABCDE`）

### メンション形式

- **ユーザーメンション**: `<@U06GH542GMS>`
- **チャンネルメンション**: `<!here>`, `<!channel>`, `<!everyone>`

このツールは**ユーザーメンションのみ**を処理対象とします。

---

**最終更新**: 2026年1月1日

